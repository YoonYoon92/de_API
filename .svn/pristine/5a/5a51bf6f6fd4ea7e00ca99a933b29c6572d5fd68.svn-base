<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.saydept.api.spf.saleNews.weekTimeSaleNews.WeekTimeSaleNewsMapper">

	<!-- 목록조회 fetchSize="1000" 옵션은 많은 수의 데이터를 조회 할 때 한번에 읽어들일  크기  -->
	<select id="selectWeekTimeSaleNewsList" resultType="com.saydept.api.spf.saleNews.weekTimeSaleNews.model.WeekTimeSaleNewsModel" parameterType="com.saydept.api.spf.saleNews.weekTimeSaleNews.model.WeekTimeSaleNewsParamModel" fetchSize="1000">
		/*selectWeekTimeSaleNewsList*/
        
		WITH 
		
		/**
		 * 시간대별 실적(11시이전)
		 */                         
		TA01A AS (
			SELECT 	'12' AS NO1, 
					'~11:00' AS SALETIME, 
					SUM(CASE WHEN IS5001=#{d6Day}     THEN IS5012 ELSE 0 END) AS SALEDAY6,
					SUM(CASE WHEN IS5001=#{d5Day}     THEN IS5012 ELSE 0 END) AS SALEDAY5,
					SUM(CASE WHEN IS5001=#{d4Day}     THEN IS5012 ELSE 0 END) AS SALEDAY4,
					SUM(CASE WHEN IS5001=#{d3Day}     THEN IS5012 ELSE 0 END) AS SALEDAY3,
					SUM(CASE WHEN IS5001=#{d2Day}     THEN IS5012 ELSE 0 END) AS SALEDAY2,
					SUM(CASE WHEN IS5001=#{d1Day}     THEN IS5012 ELSE 0 END) AS SALEDAY1,
					SUM(CASE WHEN IS5001=#{startDate} THEN IS5012 ELSE 0 END) AS SALEDAY
			FROM	SPFRDB.SPFI50PF
			WHERE 	IS5001 &lt;= #{startDate}
			AND     IS5001 &gt;= #{d6Day}			
			AND 	IS5003 = #{jum}
			<if test="bu != null and bu !=''">
			AND 	IS5003||IS5004 = #{bu}
			</if>
			<if test="tim != null and tim !=''">
			AND 	IS5003||IS5004||IS5005 = #{tim}
			</if>
			AND     IS5007 &lt;= '10'
		)
		
		/**
		 * 시간대별 실적(11~12시)
		 */
		,                         
		TA01B AS (
			SELECT 	'12' AS NO1, 
					'~13:00' AS SALETIME, 
					SUM(CASE WHEN IS5001=#{d6Day}     THEN IS5012 ELSE 0 END) AS SALEDAY6,
					SUM(CASE WHEN IS5001=#{d5Day}     THEN IS5012 ELSE 0 END) AS SALEDAY5,
					SUM(CASE WHEN IS5001=#{d4Day}     THEN IS5012 ELSE 0 END) AS SALEDAY4,
					SUM(CASE WHEN IS5001=#{d3Day}     THEN IS5012 ELSE 0 END) AS SALEDAY3,
					SUM(CASE WHEN IS5001=#{d2Day}     THEN IS5012 ELSE 0 END) AS SALEDAY2,
					SUM(CASE WHEN IS5001=#{d1Day}     THEN IS5012 ELSE 0 END) AS SALEDAY1,
					SUM(CASE WHEN IS5001=#{startDate} THEN IS5012 ELSE 0 END) AS SALEDAY
			FROM	SPFRDB.SPFI50PF
			WHERE 	IS5001 &lt;= #{startDate}
			AND     IS5001 &gt;= #{d6Day}			
			AND 	IS5003 = #{jum}
			<if test="bu != null and bu !=''">
			AND 	IS5003||IS5004 = #{bu}
			</if>
			<if test="tim != null and tim !=''">
			AND 	IS5003||IS5004||IS5005 = #{tim}
			</if>
			AND     IS5007 &lt;= '12'
			AND     IS5007 &gt;= '11'
		)
		
		/**
		 * 시간대별 실적 (13~21)
		 */  
		,                        
		TA01C AS (
			SELECT 	IS5007 AS NO1, 
					'~'||SUBSTR(DIGITS(IS5007+1),9,2)||':00' AS SALETIME, 
					SUM(CASE WHEN IS5001=#{d6Day}     THEN IS5012 ELSE 0 END) AS SALEDAY6,
					SUM(CASE WHEN IS5001=#{d5Day}     THEN IS5012 ELSE 0 END) AS SALEDAY5,
					SUM(CASE WHEN IS5001=#{d4Day}     THEN IS5012 ELSE 0 END) AS SALEDAY4,
					SUM(CASE WHEN IS5001=#{d3Day}     THEN IS5012 ELSE 0 END) AS SALEDAY3,
					SUM(CASE WHEN IS5001=#{d2Day}     THEN IS5012 ELSE 0 END) AS SALEDAY2,
					SUM(CASE WHEN IS5001=#{d1Day}     THEN IS5012 ELSE 0 END) AS SALEDAY1,
					SUM(CASE WHEN IS5001=#{startDate} THEN IS5012 ELSE 0 END) AS SALEDAY
			FROM	SPFRDB.SPFI50PF
			WHERE 	IS5001 &lt;= #{startDate}
			AND     IS5001 &gt;= #{d6Day}
			AND 	IS5003 = #{jum}
			<if test="bu != null and bu !=''">
			AND 	IS5003||IS5004 = #{bu}
			</if>
			<if test="tim != null and tim !=''">
			AND 	IS5003||IS5004||IS5005 = #{tim}
			</if>
			AND     IS5007 &gt;= '13'
			AND     IS5007 &lt;= '20'
			GROUP BY IS5007, IS5007
		)
		
		/**
		 * 시간대별 실적(22시이후)
		 */
		,                          
		TA01D AS (
			SELECT 	'23' AS NO1, 
					'~24:00' AS SALETIME, 
					SUM(CASE WHEN IS5001=#{d6Day}     THEN IS5012 ELSE 0 END) AS SALEDAY6,
					SUM(CASE WHEN IS5001=#{d5Day}     THEN IS5012 ELSE 0 END) AS SALEDAY5,
					SUM(CASE WHEN IS5001=#{d4Day}     THEN IS5012 ELSE 0 END) AS SALEDAY4,
					SUM(CASE WHEN IS5001=#{d3Day}     THEN IS5012 ELSE 0 END) AS SALEDAY3,
					SUM(CASE WHEN IS5001=#{d2Day}     THEN IS5012 ELSE 0 END) AS SALEDAY2,
					SUM(CASE WHEN IS5001=#{d1Day}     THEN IS5012 ELSE 0 END) AS SALEDAY1,
					SUM(CASE WHEN IS5001=#{startDate} THEN IS5012 ELSE 0 END) AS SALEDAY
			FROM	SPFRDB.SPFI50PF
			WHERE 	IS5001 &lt;= #{startDate}
			AND     IS5001 &gt;= #{d6Day}
			AND 	IS5003 = #{jum}
			<if test="bu != null and bu !=''">
			AND 	IS5003||IS5004 = #{bu}
			</if>
			<if test="tim != null and tim !=''">
			AND 	IS5003||IS5004||IS5005 = #{tim}
			</if>
			AND     IS5007 &gt;= '21'
		)
		
		
		/**
		 * 일 실적 합계
		 */
		,
		TA02 AS (
			SELECT  '25' AS NO1,
					'실적 계' AS GUBUN, 
					SUM(CASE WHEN IS5001=#{d6Day}     THEN IS5012 ELSE 0 END) AS DAYSALEAMOUNTD_6,
					SUM(CASE WHEN IS5001=#{d5Day}     THEN IS5012 ELSE 0 END) AS DAYSALEAMOUNTD_5,
					SUM(CASE WHEN IS5001=#{d4Day}     THEN IS5012 ELSE 0 END) AS DAYSALEAMOUNTD_4,
					SUM(CASE WHEN IS5001=#{d3Day}     THEN IS5012 ELSE 0 END) AS DAYSALEAMOUNTD_3,
					SUM(CASE WHEN IS5001=#{d2Day}     THEN IS5012 ELSE 0 END) AS DAYSALEAMOUNTD_2,
					SUM(CASE WHEN IS5001=#{d1Day}     THEN IS5012 ELSE 0 END) AS DAYSALEAMOUNTD_1,
					SUM(CASE WHEN IS5001=#{startDate} THEN IS5012 ELSE 0 END) AS DAYSALEAMOUNTD
			FROM 	SPFRDB.SPFI50PF 
			WHERE 	IS5001 &lt;= #{startDate}
			AND     IS5001 &gt;= #{d6Day}
			AND 	IS5003 = #{jum}
			<if test="bu != null and bu !=''">
			AND 	IS5003||IS5004 = #{bu}
			</if>
			<if test="tim != null and tim !=''">
			AND 	IS5003||IS5004||IS5005 = #{tim}
			</if>
		)
		
		
		/**
		 * 일 목표
		 */
		,
		TA03 AS ( 
			SELECT 	'26' AS NO1, 
					'목표' AS GUBUN, 
					SUM(CASE WHEN IS05101=#{d6Day}     THEN IS05106*1000 ELSE 0 END) AS DAYGOALD_6,
					SUM(CASE WHEN IS05101=#{d5Day}     THEN IS05106*1000 ELSE 0 END) AS DAYGOALD_5,
					SUM(CASE WHEN IS05101=#{d4Day}     THEN IS05106*1000 ELSE 0 END) AS DAYGOALD_4,
					SUM(CASE WHEN IS05101=#{d3Day}     THEN IS05106*1000 ELSE 0 END) AS DAYGOALD_3,
					SUM(CASE WHEN IS05101=#{d2Day}     THEN IS05106*1000 ELSE 0 END) AS DAYGOALD_2,
					SUM(CASE WHEN IS05101=#{d1Day}     THEN IS05106*1000 ELSE 0 END) AS DAYGOALD_1,
					SUM(CASE WHEN IS05101=#{startDate} THEN IS05106*1000 ELSE 0 END) AS DAYGOALD
			FROM	SPFRDB.SPFI05PF1  
			WHERE 	IS05101 &lt;= #{startDate}
			AND     IS05101 &gt;= #{d6Day}
			AND 	IS05102 = #{jum}
			<if test="bu != null and bu !=''">
			AND 	IS05102||IS05103 = #{bu}
			</if>
			<if test="tim != null and tim !=''">
			AND 	IS05102||IS05103||IS05104 = #{tim}
			</if>
			GROUP BY '26', '목표'
		)
		
		
		/**
		 * 실적 - 목표 차액
		 */
		,
		TA04 AS (
			SELECT 	'27' AS NO1,
					'차액' AS GUBUN,
					TA02.DAYSALEAMOUNTD_6-TA03.DAYGOALD_6 AS DIFFD_6,
					TA02.DAYSALEAMOUNTD_5-TA03.DAYGOALD_5 AS DIFFD_5,
					TA02.DAYSALEAMOUNTD_4-TA03.DAYGOALD_4 AS DIFFD_4,
					TA02.DAYSALEAMOUNTD_3-TA03.DAYGOALD_3 AS DIFFD_3,
					TA02.DAYSALEAMOUNTD_2-TA03.DAYGOALD_2 AS DIFFD_2,
					TA02.DAYSALEAMOUNTD_1-TA03.DAYGOALD_1 AS DIFFD_1,
					TA02.DAYSALEAMOUNTD  -TA03.DAYGOALD   AS DIFFD
			FROM 	TA02, TA03
		)
		
		/**
		 * 일 달성율
		 */
		,
		TA05 AS (
			SELECT 	'28' AS NO1,
					'달성율' AS GUBUN,
					FLOAT(TA02.DAYSALEAMOUNTD_6) /FLOAT(TA03.DAYGOALD_6)*100 AS ACHIVERAT_6,
					FLOAT(TA02.DAYSALEAMOUNTD_5) /FLOAT(TA03.DAYGOALD_5)*100 AS ACHIVERAT_5,
					FLOAT(TA02.DAYSALEAMOUNTD_4) /FLOAT(TA03.DAYGOALD_4)*100 AS ACHIVERAT_4,
					FLOAT(TA02.DAYSALEAMOUNTD_3) /FLOAT(TA03.DAYGOALD_3)*100 AS ACHIVERAT_3,
					FLOAT(TA02.DAYSALEAMOUNTD_2) /FLOAT(TA03.DAYGOALD_2)*100 AS ACHIVERAT_2,
					FLOAT(TA02.DAYSALEAMOUNTD_1) /FLOAT(TA03.DAYGOALD_1)*100 AS ACHIVERAT_1,
					FLOAT(TA02.DAYSALEAMOUNTD  ) /FLOAT(TA03.DAYGOALD  )*100 AS ACHIVERAT
			FROM 	TA02, TA03
		)    
		
		
		/**
		 * 전년실적
		 */
		,
		TA06 AS ( 
			SELECT 	'29' AS NO1, 
					'전년실적' AS GUBUN, 
					SUM(CASE WHEN IS5201=#{oldD6Day}      THEN IS5213 ELSE 0 END) AS LASTYEARSALEAMOUNT_6,
					SUM(CASE WHEN IS5201=#{oldD5Day}      THEN IS5213 ELSE 0 END) AS LASTYEARSALEAMOUNT_5,
					SUM(CASE WHEN IS5201=#{oldD4Day}      THEN IS5213 ELSE 0 END) AS LASTYEARSALEAMOUNT_4,
					SUM(CASE WHEN IS5201=#{oldD3Day}      THEN IS5213 ELSE 0 END) AS LASTYEARSALEAMOUNT_3,
					SUM(CASE WHEN IS5201=#{oldD2Day}      THEN IS5213 ELSE 0 END) AS LASTYEARSALEAMOUNT_2,
					SUM(CASE WHEN IS5201=#{oldD1Day}      THEN IS5213 ELSE 0 END) AS LASTYEARSALEAMOUNT_1,
					SUM(CASE WHEN IS5201=#{oldStartDate}  THEN IS5213 ELSE 0 END) AS LASTYEARSALEAMOUNT
			FROM	SPFRDB.SPFI52PF  
			WHERE 	IS5201 &lt;= #{oldStartDate}
			AND     IS5201 &gt;= #{oldD6Day} 
			AND 	IS5203 = #{jum}
			<if test="bu != null and bu !=''">
			AND 	IS5203||IS5204 = #{bu}
			</if>
			<if test="tim != null and tim !=''">
			AND 	IS5203||IS5204||IS5205 = #{tim}
			</if>
			GROUP BY '29', '전년실적'
		)
		
		/**
		 * 전년대비 신장율
		 */
		,
		TA07 AS (
			SELECT 	'30' AS NO1,
					'신장율' AS GUBUN,
					CASE WHEN FLOAT(TA06.LASTYEARSALEAMOUNT_6)>0 
						 THEN (FLOAT(TA02.DAYSALEAMOUNTD_6) -FLOAT(TA06.LASTYEARSALEAMOUNT_6))/FLOAT(LASTYEARSALEAMOUNT_6)*100
						 ELSE (FLOAT(TA06.LASTYEARSALEAMOUNT_6) -FLOAT(TA02.DAYSALEAMOUNTD_6))/FLOAT(LASTYEARSALEAMOUNT_6)*100 END AS STRECHRAT_6,
					CASE WHEN FLOAT(TA06.LASTYEARSALEAMOUNT_5)>0 
						 THEN (FLOAT(TA02.DAYSALEAMOUNTD_5) -FLOAT(TA06.LASTYEARSALEAMOUNT_5))/FLOAT(LASTYEARSALEAMOUNT_5)*100
						 ELSE (FLOAT(TA06.LASTYEARSALEAMOUNT_5) -FLOAT(TA02.DAYSALEAMOUNTD_5))/FLOAT(LASTYEARSALEAMOUNT_5)*100 END AS STRECHRAT_5,
					CASE WHEN FLOAT(TA06.LASTYEARSALEAMOUNT_4)>0 
						 THEN (FLOAT(TA02.DAYSALEAMOUNTD_4) -FLOAT(TA06.LASTYEARSALEAMOUNT_4))/FLOAT(LASTYEARSALEAMOUNT_4)*100
						 ELSE (FLOAT(TA06.LASTYEARSALEAMOUNT_4) -FLOAT(TA02.DAYSALEAMOUNTD_4))/FLOAT(LASTYEARSALEAMOUNT_4)*100 END AS STRECHRAT_4,
					CASE WHEN FLOAT(TA06.LASTYEARSALEAMOUNT_3)>0 
						 THEN (FLOAT(TA02.DAYSALEAMOUNTD_3) -FLOAT(TA06.LASTYEARSALEAMOUNT_3))/FLOAT(LASTYEARSALEAMOUNT_3)*100
						 ELSE (FLOAT(TA06.LASTYEARSALEAMOUNT_3) -FLOAT(TA02.DAYSALEAMOUNTD_3))/FLOAT(LASTYEARSALEAMOUNT_3)*100 END AS STRECHRAT_3,
					CASE WHEN FLOAT(TA06.LASTYEARSALEAMOUNT_2)>0 
						 THEN (FLOAT(TA02.DAYSALEAMOUNTD_2) -FLOAT(TA06.LASTYEARSALEAMOUNT_2))/FLOAT(LASTYEARSALEAMOUNT_2)*100
						 ELSE (FLOAT(TA06.LASTYEARSALEAMOUNT_2) -FLOAT(TA02.DAYSALEAMOUNTD_2))/FLOAT(LASTYEARSALEAMOUNT_2)*100 END AS STRECHRAT_2,
					CASE WHEN FLOAT(TA06.LASTYEARSALEAMOUNT_1)>0 
						 THEN (FLOAT(TA02.DAYSALEAMOUNTD_1) -FLOAT(TA06.LASTYEARSALEAMOUNT_1))/FLOAT(LASTYEARSALEAMOUNT_1)*100
						 ELSE (FLOAT(TA06.LASTYEARSALEAMOUNT_1) -FLOAT(TA02.DAYSALEAMOUNTD_1))/FLOAT(LASTYEARSALEAMOUNT_1)*100 END AS STRECHRAT_1,
					CASE WHEN FLOAT(TA06.LASTYEARSALEAMOUNT)>0 
						 THEN (FLOAT(TA02.DAYSALEAMOUNTD) -FLOAT(TA06.LASTYEARSALEAMOUNT))/FLOAT(LASTYEARSALEAMOUNT)*100
						 ELSE (FLOAT(TA06.LASTYEARSALEAMOUNT) -FLOAT(TA02.DAYSALEAMOUNTD))/FLOAT(LASTYEARSALEAMOUNT)*100       END AS STRECHRAT
			FROM 	TA02, TA06
		)    
		
		
		
		
		
		
		/**
		 * 시간대별 속보 화면 union 
		 */
		 
		 
		SELECT * FROM TA01A 
		UNION ALL
		SELECT * FROM TA01B 
		UNION ALL
		SELECT * FROM TA01C
		UNION ALL
		SELECT * FROM TA01D 
		UNION ALL
		SELECT * FROM TA02
		UNION ALL
		SELECT * FROM TA03
		UNION ALL
		SELECT * FROM TA04
		UNION ALL
		SELECT * FROM TA05
		UNION ALL
		SELECT * FROM TA06
		UNION ALL
		SELECT * FROM TA07
		ORDER BY NO1 

	</select>

</mapper>